apiVersion: v1
kind: ConfigMap
metadata:
  name: log-forwarder-script
  namespace: default
data:
  forward-logs.sh: |
    #!/bin/sh
    while true; do
      # Get user-service logs
      kubectl logs -l app=user-service --tail=50 --since=30s 2>/dev/null | while IFS= read -r line; do
        if [ -n "$line" ]; then
          timestamp=$(date -u +%s)000000000
          json="{\"streams\":[{\"stream\":{\"pod\":\"user-service\",\"namespace\":\"default\",\"app\":\"user-service\"},\"values\":[[\"${timestamp}\",\"$(echo "$line" | sed 's/"/\\"/g')\"]]}]}"
          echo "$json" | curl -s -X POST -H "Content-Type: application/json" http://loki:3100/loki/api/v1/push --data-binary @- > /dev/null 2>&1
        fi
      done
      
      # Get order-service logs
      kubectl logs -l app=order-service --tail=50 --since=30s 2>/dev/null | while IFS= read -r line; do
        if [ -n "$line" ]; then
          timestamp=$(date -u +%s)000000000
          json="{\"streams\":[{\"stream\":{\"pod\":\"order-service\",\"namespace\":\"default\",\"app\":\"order-service\"},\"values\":[[\"${timestamp}\",\"$(echo "$line" | sed 's/"/\\"/g')\"]]}]}"
          echo "$json" | curl -s -X POST -H "Content-Type: application/json" http://loki:3100/loki/api/v1/push --data-binary @- > /dev/null 2>&1
        fi
      done
      
      sleep 10
    done
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log-forwarder
  namespace: default
  labels:
    app: log-forwarder
spec:
  replicas: 1
  selector:
    matchLabels:
      app: log-forwarder
  template:
    metadata:
      labels:
        app: log-forwarder
    spec:
      serviceAccountName: promtail
      containers:
      - name: log-forwarder
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "/scripts/forward-logs.sh"]
        volumeMounts:
        - name: script
          mountPath: /scripts
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: script
        configMap:
          name: log-forwarder-script
          defaultMode: 0755

